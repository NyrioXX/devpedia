# **Amazon Elastic Compute Cloud (EC2)**

O EC2 é uma maquina virtual e seu uso mais comum é como servidor

- O EC2 é considerado um IaaS

- O EC2 permite controle total sobre o sistema operacional (windows ou linux) em cada instancia

- Instancias são inicializadas com **_`imagens de maquina da Amazon (AMIs)`_**, podem ter qualquer tamanho e estar em qualquer zona de disponibilidade. São implementadas com poucos cliques ou linha de codigo e são provisionadas em poucos minutos

- É possivel controlar o trafego de ida e de volta para as instancias

- A instancia pode ser implantada via interface grafica AWS ou por CLI

## **9 Passos para implantar um instancia EC2**

### 1. **_Selecionar uma AMI_**

- A AMI contem uma imagem de SO

- É possivel configurar quais contas AWS podem usar determinada AMI

- É possivel especificar quais volumes de bloco (armazenamento) serão anexados a instancia (se houver)

- É possivel configurar uma instancia e replica-la utilizando sua AMI, bem como recupera-la (serve como backup de maquina virtual)

- Pode ter software pré-instalado

- É possivel iniciar varias instancias com a mesma AMI

- `Modo quickstart`: possui uma imagem windows ou linux

- `Modo minhas AMIs`: possui AMIs criadas pelo usuario

- `Modo AWS Marketplace`: Catalogo de modelos de EC2 configurados por terceiros e validados pela AWS

- `Modo AMI de comunidade`: são AMIs criadas pela comunidade e deve ser usado por conta e risco do usuario

### 2. **_Tipo de instância_**

- O tipo de instancia determinará:

1.  Memoria RAM
2.  Capacidade de processamento (CPU)
3.  Espaço e tipo de disco (armazenamento)
4.  Desempenho de rede

- Categorias de tipo de instância:

1.  Uso geral
2.  Otimizadas para computação
3.  Otimizadas para memória
4.  Otimizadas para armazenamento
5.  Computação acelerada

- Nomes da instancia
  - exemplo: t3.large -> **`T`** (nome da familia) **`3`** (geração) .**`large`** (tamanho)
- Quanto maior a geração mais potente e mais caro

### 3. **_Configurações de rede_**

- A largura de rede de uma instancia varia de acordo com o seu tipo

- Para otimizar o desempenho de rede e largura de banda:

  - Se o usuario tiver instâncias interdependentes, inicie-as em um grupo de colocação de cluster
  - Habilite a rede avançada

- Os tipos de rede são compativeis com a maioria dos tipos de instancia

- **_A Elastic Network Adapter_** é um tipo de rede avançada que comporta velocidades de até 100 Gbps

- Deve ser especificada em qual VPC, e opcionalmente a sub-rede, na qual a instancia EC2 será usada

- Definir se um IP publico deve ser usado. Por padrão a AWS atribui um IP publico caso a instancia não esteja numa sub-rede

- Uma outra parte da configuração de rede é o gateway da Internet

  - Um gateway da Internet é um componente de VPC dimensionado horizontalmente, redundante e altamente disponível que permite a comunicação entre as instâncias na sua VPC e na Internet

- Um gateway privado virtual é um componente opcional compatível com conexões VPN

  - O gateway privado virtual fica no lado da Amazon da conexão de rede privada virtual (VPN)
  - O usuario cria um gateway privado virtual e o anexa à VPC em que deseja criar a conexão de VPN
  - O lado do cliente da conexão VPN tem um gateway do cliente, que é um dispositivo físico ou aplicativo de software

- Cada grupo de segurança define um conjunto de regras de firewall para suas instâncias, que permitem ou bloqueiam o tráfego de entrada e saída

- Os security groups atuam no nível da instância, não no nível da subnet. Portanto, cada instância em uma sub-rede na VPC pode ser atribuída a um conjunto diferente de grupos de segurança

- Se um grupo em particular não for especificado no momento da execução, a instância será automaticamente atribuída ao grupo de segurança padrão da VPC

- Um `endereço IP privado` é sempre atribuído a cada instância quando ela é iniciada

  - É alocado para a instância do pool de endereços IP privados que estão disponíveis na sub-rede
  - Os endereços IP privados permitem a comunicação entre instâncias do EC2 na VPC

- Um `endereço IP público` pode ser atribuído opcionalmente a uma instância do EC2

  - É gerado dinamicamente a partir de um grupo de endereços IP públicos da AWS disponíveis
  - Os clientes podem usar o endereço IP público para se conectar à instância pela Internet
  - Se uma instância for interrompida e, em seguida, iniciada novamente, ela receberá um novo endereço IP público
  - No entanto, se o usuario reinicializar uma instância, ela manterá o mesmo endereço IP público

- Um `endereço IP elástico` é um endereço IP publicamente acessível, alocado a partir de um grupo de endereços IP públicos da AWS

  - Opcionalmente, um endereço IP elástico pode ser provisionado e, em seguida, atribuído a uma instância do EC2
  - Endereços IP elásticos são semelhantes a endereços IP públicos, exceto pelo fato de um endereço IP elástico ser estático
  - É possível reatribuir um endereço IP elástico a outra instância a qualquer momento

- Uma conexão entre duas ou mais VPCs é conhecida como conexão de emparelhamento

### 4. **_Função do IAM (Opcional)_**

- Caso a instancia precise interagir com outros serviços AWS uma função IAM apropriada deve ser anexada

- A função IAM anexada é mantida em um **`perfil de instancia`**

  - Um perfil de instancia é um container para IAM
  - Evita armazenar a chave de acesso e a chave secreta localmente no EC2
  - Permite anexar uma função do AWS Identity and Access Management (IAM) a uma instância do EC2
  - Propagação automática de chaves de acesso para instâncias
    - Rotação automática de chaves de acesso várias vezes ao dia
    - Use em várias instâncias (por exemplo, grupo do Auto Scaling)

- É possivel anexar uma função IAM a instancias já existentes

- `Nunca se deve armazenar credenciais AWS em uma instancia EC2`

### 5. **_Dados do usuário (Opcional)_**

- É possivel especificar um script de dados do usuario ao iniciar uma instancia. O script é usado na primeira execução

- Serve para personalizar o ambiente de tempo de execução da instancia

- Pode ser usado, por exemplo, para reduzir a quantidade de AMIs personalizadas

### 6. **_Opções de armazenamento_**

- Configurar o volume raiz onde o SO será instalado

- Anexar volumes adicionais (opcional)

- Especificar para cada volume

  1.  Tamanho do disco (em GB)
  2.  Tipo de volume (SSD ou HDD)
  3.  Determinar se o volume será excluido quando a instancia for terminada
  4.  Se a criptografia precisar ser usada

- Opções de armazenamento:

  1.  Elastic block store (EBS) - é possivel interromper a instancia e os dados permanecerão
  2.  Armazenamento de instancias EC2 - armazenamento temporario que é perdido caso a instancia seja interrompida

- Outras opções de armazenamento (não servem para ser volume raiz)
  1.  Elastic file system
  2.  Amazon S3

### 7. **_Tags_**

- É um rotulo que consiste em uma chave e um valor opcional

- Beneficios: filtragem, automação, alocação de custos e controle de acesso

- Serve para anexar metadados a uma instancia EC2

  - Dados sobre sua instância, que o usuario pode usar para configurar ou gerenciar a instância em execução

  - O serviço de metadados é fornecido para cada instância no seguinte endereço IP: 169.254.169.254

  - Metadados da instância de consulta
    1.  ami-id
    2.  ami-launch-index
    3.  ami-manifest-path
    4.  block-device-mapping/
    5.  events/
    6.  hostname
    7.  iam/
    8.  instance-action
    9.  instance-id
    10. instance-type
    11. local-hostname
    12. ... continua (lista grande)

- Como ver os metadados

```bash
# criar uma variavel com o cURL
export INSTANCE_ID=$(curl http://169.254.169.254/latest/meta-data/instance-id)
# usa a variavel num comando
aws ec2 describe-instances --instance-id $INSTANCE_ID
```

### 8. **_Security group_**

- Configurar o conjunto de regras de firewall que controlam o trafego da instancia

- Configurar regras que definam as fontes, as portas e os protocolos (UTP,TCP,ICMP) que serão usadas

- Além de restringir por quais portas o tráfego pode fluir, também é possível restringir a partir de quais endereços IP o tráfego pode se originar

- Se o intervalo de endereços IP de origem for definido como 0.0.0.0/0, nessa porta será permitido tráfego a partir de qualquer origem. No entanto, o usuario também pode especificar um endereço IP específico, um intervalo de roteamento sem classe entre domínios (CIDR)

- Ou o usuario pode habilitar apenas fontes na Nuvem AWS que tenham um grupo de segurança específico atribuído a elas

- É possível atribuir vários grupos de segurança a uma única instância

  - Por exemplo, o usuario pode criar um grupo de segurança administrativo, que permitiria tráfego na porta TCP 22. O usuario também pode criar um grupo de segurança de servidor de banco de dados, que permitiria tráfego na porta TCP 3306. Em seguida, o usuario pode atribuir esses dois grupos de segurança a uma instância

- Se não existirem regras de saida entao por padrão nenhum trafego de saida será permitido

### 9. **_Par de chaves_**

- Especificar ou criar um par de chaves é fundamental para o uso da instancia e consiste em uma chave publica que a AWS armazena e uma chave privada que o usuario armazena

- O par permite conexões seguras com a instancia

- Para AMI Windows a chave serve para obter a senha do Admin necessaria para logar na instancia

- Para AMI Linux a chave serve para usar SSH e conectar com a instancia

- O Amazon EC2 incentiva o uso da criptografia de chave pública para criptografar e descriptografar informações de login

- A criptografia de chave pública usa uma chave pública para criptografar uma parte dos dados, como a senha

- O destinatário então usa uma chave privada para descriptografar os dados. As chaves pública e privada são conhecidas como par de chaves. É necessário um par de chaves para fazer login na instância

- O usuario precisa de um par de chaves conhecido e registrado nas configurações do Secure Shell (SSH) do sistema operacional ao qual o usuario está se conectando

- Normalmente, o usuario especifica o nome do par de chaves ao iniciar a instância pela primeira vez

- O usuario pode criar um novo par de chaves e baixá-lo como parte do processo de execução da instância. Ou, ao executar a instância, o usuario pode especificar um par de chaves ao qual o usuario já tem acesso

- Quando a instância é executada, a AWS cuida do processo de configuração da instância para aceitar o par de chaves que o usuario especificar

- Depois que a instância for inicializada e o usuario desejar se conectar a ela, será possível usar a chave privada para tal

  - As configurações padrão de SSH em instâncias do Linux não solicitam uma senha. Em vez disso, as instâncias do Linux esperam que o usuario use um par de chaves para fazer login, embora seja possível configurar esse processo com AMIs personalizadas
  - Em instâncias do Windows, normalmente um par de chaves é usado para descriptografar a senha de administrador e, em seguida, o login é realizado usando o Remote Desktop Protocol (RDP)

- A senha de usuário Administrador padrão para instâncias do Microsoft Windows e o ec2-user (ou outra senha de usuário padrão) em instâncias do Linux são pontos de partida. Cabe a você definir sua própria segurança no nível da instância e decidir como concederá e revogará permissões para acesso à instância à medida que as pessoas ingressarem e saírem da sua organização

- Para instâncias do Microsoft Windows, use o AWS Directory Service para conceder e revogar acesso a máquinas com base em usuários e grupos existentes do Windows

- Para instâncias do Linux, várias opções de segurança estão disponíveis. Muitos administradores de sistemas optam por usar o `Kerberos`, um protocolo de autenticação de rede que usa criptografia de chave secreta para fornecer autenticação entre clientes e servidores

  - O Kerberos pode fazer parte de uma solução de Autenticação única (SSO)

- Outros administradores de sistemas Linux optam por usar ferramentas como o `ssh-keygen` para gerar seus próprios pares de chaves públicas/privadas para usuários que precisam acessar instâncias do EC2

  - Quando essa opção é escolhida, os detalhes da chave pública são configurados no arquivo.ssh/authorized_keys do usuário e a chave privada é distribuída ao usuário

- Cabe ao cliente da AWS elaborar uma estratégia para adicionar e remover permissões em uma infraestrutura de instâncias em execução

- Você pode criar AMIs que contenham todos os usuários atuais da sua empresa. No entanto, essa abordagem é um tanto inflexível e pode ser difícil de gerenciar até mesmo em algumas AMIs

- Aplicativos de gerenciamento de configuração (como o `Chef`, o `Puppet` e o `Ansible`) podem simplificar bastante o processo de concessão e revogação de acesso em um grande número de máquinas. Muitas vezes reduz o processo para alguns comandos

## **Ciclo de vida de uma instancia**

- **_Status das instancias:_**
  - **_Pendente_**: quando uma instância é executada pela primeira vez em uma AMI ou quando o usuario inicia uma instância interrompida, ela entra no estado pendente no momento em que a instância é inicializada e implantada em um computador host. O tipo de instância que o usuario especificou na inicialização determina o hardware de computador host para sua instância.
  - **_Em execução_**: quando a instância está totalmente inicializada e pronta, ela sai do estado pendente e entra no estado em execução. É possível se conectar à instância em execução pela Internet.
  - **_Reinicializando_**: em vez de invocar uma reinicialização do sistema operacional convidado da instância, a AWS recomenda reinicializar a instância usando o console do Amazon EC2, a AWS Command Line Interface (AWS CLI) ou os Kits de Desenvolvimento de Software (SDKs) da AWS. Uma instância reinicializada permanece no mesmo host físico e mantém o mesmo nome de DNS público e o mesmo endereço IP público. Se a instância tiver volumes de armazenamento de instâncias, ela reterá os dados nesses volumes.
  - **_Desligando_**: este é um estado intermediário entre em execução e terminada.
  - **_Terminada_**: uma instância terminada permanece no console do Amazon EC2 por um tempo antes da exclusão da máquina virtual. Porém, não é possível conectar-se nem recuperar uma instância terminada.
  - **_Interrupção_**: as instâncias com suporte do Amazon EBS podem ser interrompidas. Eles entram no estado de interrupção antes de atingir o estado totalmente interrompido.
  - **_Interrompida_**: uma instância interrompida não incorrerá no mesmo custo que uma instância em execução. Ao iniciar uma instância interrompida, o usuario a retorna ao estado pendente, o que a move para uma nova máquina host

## **Modelos de preço**

- **_Instancias on-demand_** (Baixo custo e flexibilidade)
  - Pagamento por hora
  - Sem compromisso de longo prazo
  - Qualificado para o nivel gratuito da AWS
  - Possui a opção de cobrança por segundo
- **_Hosts dedicados_** (Atende requesitos regulatorios/conformidade)
  - Um servidor fisico com capacidade de instancia EC2 totalmente dedicado para uso
- **_Instancias dedicadas_** ()
  - Instancias que são executadas em uma VPC em hardware dedicado a um unico cliente
- **_Instancias reservadas_** (Baixo custo e previsibilidade)
  - Pagamento total, parcial ou não antecipado para a instancia que o cliente reservar
  - Desconto na cobrança por hora
  - Periodo de 1 a 3 anos
  - Possui a opção de cobrança por segundo
- **_Instancias reservadas programadas_** (Baixo custo e previsibilidade)
  - Compra uma reserva de capacidade que estará disponivel no periodo escolhido pelo cliente
  - Periodo de 1 ano
- **_Instancias Spot_**(Dinamica, larga escala, custo competitivo)
  - As instancias são executadas desde que estejam disponiveis e a sua sugestão de preço seja superior ao preço da instancia spot
  - Podem ser interrompidas pela AWS com uma notificação de 2 minutos
  - Pode ser interrompida, hibernada ou terminada
  - Os preços podem ser bem menores que as instancias on-demand
  - Boa opção quando se tem flexibilidade sobre quando os aplicativos podem ser executados
  - É feito o pagamento pela programação de uso mesmo que não aconteça
  - Permite que o usuario faça sugestões de preço em instâncias do EC2 não utilizadas, o que pode reduzir seus custos do significativamente. O preço por hora de uma instância spot varia de acordo com a oferta e a demanda. A instância spot é executada sempre que sua sugestão de preço excede o preço de mercado atual.

## **Como funciona**

- As instâncias do EC2 são executadas como máquinas virtuais em computadores host localizados nas zonas de disponibilidade da AWS

- Cada máquina virtual executa um sistema operacional (SO), como Amazon Linux ou Microsoft Windows

- É possível instalar e executar aplicativos no sistema operacional em cada máquina virtual ou até mesmo executar aplicativos empresariais que abrangem várias máquinas virtuais

- As máquinas virtuais são executadas sobre uma camada de hipervisor, que é mantida pela AWS

  - O hipervisor é a camada de plataforma operacional que fornece às instâncias do EC2 acesso ao hardware real que as instâncias precisam executar
  - Esse hardware inclui processadores,memória e armazenamento
  - Cada instância do EC2 recebe um número específico de CPUs virtuais para processamento e uma quantidade de memória ou RAM

- Algumas instâncias do EC2 usam um armazenamento de instâncias

  - O armazenamento de instâncias também é conhecido comoarmazenamento temporário
  - É um armazenamento fisicamente conectado ao computador host e fornece armazenamento temporário em nível de bloco para uso com uma instância
  - Os dados em um armazenamento de instâncias persistem apenas durante o tempo de vida da instância à qual estão associados
  - Se uma instância for reinicializada, os dados no armazenamento de instâncias persistirão
  - Se a instância for interrompida ou encerrada, os dados no armazenamento de instâncias serão perdidos e não poderão ser recuperados

- Muitas instâncias do EC2 usam o Amazon Elastic Block Store (Amazon EBS) para o disco de inicialização e outras necessidades de armazenamento, em vez de um armazenamento de instâncias

- O Amazon EBS fornece volumes persistentes de armazenamento em bloco, o que significa que os dados serão persistidos

  - Por exemplo, os dados ainda persistem nessa instância, mesmo quando a instância do EC2 está em um estado interrompido

- As instâncias otimizadas para Amazon EBS minimizam a contenção de entrada/saída (E/S) entre o Amazon EBS e outro tráfego da sua instância, o que fornece melhores garantias de desempenho

- A contenção de E/S ocorre quando as máquinas virtuais competem por recursos de E/S porque há uma largura de banda de armazenamento limitada

- As instâncias do EC2 podem ter conectividade de rede com outros recursos

- Esses recursos podem ser outras instâncias do EC2, armazenamento de objetos do Amazon Simple Storage Service (Amazon S3) e a Internet em geral

- É possível configurar o grau de acesso à rede para atender às suas demandas e equilibrar as necessidades de acessibilidade com os requisitos de segurança

- Diferentes tipos de instância fornecem níveis diferentes de desempenho de rede

- Os tipos de instância referem-se à seleção disponível de instâncias a serem escolhidas para suas cargas de trabalho

- Existem muitos tipos de instâncias, alguns são de uso geral, enquanto outros são projetados para fornecer CPU adicional (potência de processamento), RAM adicional (memória) ou desempenho adicional de rede de E/S

- Há muitas variações, categorias, famílias e tipos

- O usuario deve escolher o tipo de instância mais econômico que ofereça suporte aos requisitos da carga de trabalho

- Outra opção útil que pode ser invocada quando o usuario executa uma instância a partir de uma AMI é o parâmetro de dados do usuário

- Os dados do usuário são uma ferramenta poderosa que pode ajudar a implantar instâncias do EC2 de forma automatizada e repetível

- Com os dados do usuário, é possível fornecer um script para uma instância do Linux ou Windows

- Quando a instância é executada, esse script é executado como uma série de comandos durante o fim do processo de inicialização

- Os scripts assumem a forma de scripts de shell em instâncias do Linux ou scripts em lote ou PowerShell em instâncias do Windows

- Ao usar os dados do usuário, é possível automatizar a configuração de uma nova instância sem precisar fazer login nela

- Um script de dados de usuário pode, por exemplo, fazer download e executar um script mais longo armazenado em um bucket do Amazon S3

- Também é possivel fazer download e instalar um sistema de gerenciamento de configuração, como o Chef ou o Puppet. Em seguida, inicie uma tarefa de inicialização de um receita do `Chef` ou de um módulo `Puppet`

- Além disso, é possível chamar comandos da Interface de linhas de comando da AWS (AWS CLI) a partir de seus scripts. Esse processo pressupõe que o usuario inclua código ou instruções para instalar a AWS CLI anteriormente no seu script. (Essas instruções não seriam necessárias se a instância já tiver a AWS CLI pré-instalada nela)

- As instâncias do Amazon Linux vêm com a CLI do AWS pré-instalada nelas

- Os scripts de dados do usuário são executados pelo serviço cloud-init em instâncias do Linux ou pelo serviço EC2Launch em instâncias do Windows

- Por padrão, scripts de dados do usuário e diretivas cloud-init são executados somente durante o primeiro ciclo de inicialização quando uma instância é iniciada. No entanto, o usuario pode configurar scripts de dados do usuário e diretivas cloud-init para serem executadas sempre que a instância for reiniciada a partir de um estado interrompido

- Para fornecer visibilidade sobre o estado das instâncias, a AWS oferece a capacidade de gerar e salvar uma captura de tela do console da instância a partir do Console de gerenciamento da AWS

- Para ajudar a proteger contra a perda de dados causada pelo encerramento acidental de uma instância do Amazon EC2, considere habilitar a proteção contra encerramento

  - A proteção contra encerramento impede que uma instância seja encerrada acidentalmente, exigindo que a proteção contra encerramento seja desativada antes que a instância possa ser encerrada

- Por padrão, toda instância do EC2 executa verificações de origem/destino. Isso significa que a instância deve ser a origem ou o destino de qualquer tráfego que ela envia ou recebe. Entretanto, a instância de conversão de endereços de rede (NAT) deve poder enviar e receber tráfego quando ela não for a origem nem o destino. Por isso, é preciso desativar as verificações de origem/destino na instância NAT

- Executar o Amazon EC2 na CLI da AWS

  ```bash
  aws ec2 run-instances --image-id ami-0123456789012345 --instance-type t2.micro --key-name mykeypair --security-group-ids sg-0123456789012345 --subnet-id subnet-0123456789012345 --iam-instance-profile Name=EC2Admin --user-data file://UserData.txt
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=WebServer}]'
  ```

  - O parâmetro subnet-id é opcional. Se você não especificar um, a instância será executada na sub-rede padrão da VPC padrão
  - O parâmetro tag-specifications permite aplicar tags, como um valor de nome à instância
