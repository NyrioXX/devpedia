# **Amazon Elastic Compute Cloud (EC2)**

O EC2 é uma maquina virtual e seu uso mais comum é como servidor

- O EC2 é considerado um IaaS

- O EC2 permite controle total sobre o sistema operacional (windows ou linux) em cada instancia

- Instancias são inicializadas com **_`imagens de maquina da Amazon (AMIs)`_**, podem ter qualquer tamanho e estar em qualquer zona de disponibilidade. São implementadas com poucos cliques ou linha de codigo e são provisionadas em poucos minutos

- É possivel controlar o trafego de ida e de volta para as instancias

- A instancia pode ser implantada via interface grafica AWS ou por CLI

## **9 Passos para implantar um instancia EC2**

### 1. **_Selecionar uma AMI_**

- A AMI contem uma imagem de SO

- É possivel configurar quais contas AWS podem usar determinada AMI

- É possivel especificar quais volumes de bloco (armazenamento) serão anexados a instancia (se houver)

- É possivel configurar uma instancia e replica-la utilizando sua AMI, bem como recupera-la (serve como backup de maquina virtual)

- Pode ter software pré-instalado

- É possivel iniciar varias instancias com a mesma AMI

- `Modo quickstart`: possui uma imagem windows ou linux

- `Modo minhas AMIs`: possui AMIs criadas pelo usuario

- `Modo AWS Marketplace`: Catalogo de modelos de EC2 configurados por terceiros e validados pela AWS

- `Modo AMI de comunidade`: são AMIs criadas pela comunidade e deve ser usado por conta e risco do usuario

### 2. **_Tipo de instância_**

- O tipo de instancia determinará:

1.  Memoria RAM
2.  Capacidade de processamento (CPU)
3.  Espaço e tipo de disco (armazenamento)
4.  Desempenho de rede

- Categorias de tipo de instância:

1.  Uso geral
2.  Otimizadas para computação
3.  Otimizadas para memória
4.  Otimizadas para armazenamento
5.  Computação acelerada

- Nomes da instancia
  - exemplo: t3.large -> **`T`** (nome da familia) **`3`** (geração) .**`large`** (tamanho)
- Quanto maior a geração mais potente e mais caro

### 3. **_Configurações de rede_**

- A largura de rede de uma instancia varia de acordo com o seu tipo

- Para otimizar o desempenho de rede e largura de banda:

  - Se o usuario tiver instâncias interdependentes, inicie-as em um grupo de colocação de cluster
  - Habilite a rede avançada

- Os tipos de rede são compativeis com a maioria dos tipos de instancia

- **_A Elastic Network Adapter_** é um tipo de rede avançada que comporta velocidades de até 100 Gbps

- Deve ser especificada em qual VPC, e opcionalmente a sub-rede, na qual a instancia EC2 será usada

- Definir se um IP publico deve ser usado. Por padrão a AWS atribui um IP publico caso a instancia não esteja numa sub-rede

- Uma outra parte da configuração de rede é o gateway da Internet

  - Um gateway da Internet é um componente de VPC dimensionado horizontalmente, redundante e altamente disponível que permite a comunicação entre as instâncias na sua VPC e na Internet

- Um gateway privado virtual é um componente opcional compatível com conexões VPN

  - O gateway privado virtual fica no lado da Amazon da conexão de rede privada virtual (VPN)
  - O usuario cria um gateway privado virtual e o anexa à VPC em que deseja criar a conexão de VPN
  - O lado do cliente da conexão VPN tem um gateway do cliente, que é um dispositivo físico ou aplicativo de software

- Cada grupo de segurança define um conjunto de regras de firewall para suas instâncias, que permitem ou bloqueiam o tráfego de entrada e saída

- Os security groups atuam no nível da instância, não no nível da subnet. Portanto, cada instância em uma sub-rede na VPC pode ser atribuída a um conjunto diferente de grupos de segurança

- Se um grupo em particular não for especificado no momento da execução, a instância será automaticamente atribuída ao grupo de segurança padrão da VPC

- Um `endereço IP privado` é sempre atribuído a cada instância quando ela é iniciada

  - É alocado para a instância do pool de endereços IP privados que estão disponíveis na sub-rede
  - Os endereços IP privados permitem a comunicação entre instâncias do EC2 na VPC

- Um `endereço IP público` pode ser atribuído opcionalmente a uma instância do EC2

  - É gerado dinamicamente a partir de um grupo de endereços IP públicos da AWS disponíveis
  - Os clientes podem usar o endereço IP público para se conectar à instância pela Internet
  - Se uma instância for interrompida e, em seguida, iniciada novamente, ela receberá um novo endereço IP público
  - No entanto, se o usuario reinicializar uma instância, ela manterá o mesmo endereço IP público

- Um `endereço IP elástico` é um endereço IP publicamente acessível, alocado a partir de um grupo de endereços IP públicos da AWS

  - Opcionalmente, um endereço IP elástico pode ser provisionado e, em seguida, atribuído a uma instância do EC2
  - Endereços IP elásticos são semelhantes a endereços IP públicos, exceto pelo fato de um endereço IP elástico ser estático
  - É possível reatribuir um endereço IP elástico a outra instância a qualquer momento

- Uma conexão entre duas ou mais VPCs é conhecida como conexão de emparelhamento

### 4. **_Função do IAM (Opcional)_**

- Caso a instancia precise interagir com outros serviços AWS uma função IAM apropriada deve ser anexada

- A função IAM anexada é mantida em um **`perfil de instancia`**

  - Um perfil de instancia é um container para IAM
  - Evita armazenar a chave de acesso e a chave secreta localmente no EC2
  - Permite anexar uma função do AWS Identity and Access Management (IAM) a uma instância do EC2
  - Propagação automática de chaves de acesso para instâncias
    - Rotação automática de chaves de acesso várias vezes ao dia
    - Use em várias instâncias (por exemplo, grupo do Auto Scaling)

- É possivel anexar uma função IAM a instancias já existentes

- `Nunca se deve armazenar credenciais AWS em uma instancia EC2`

### 5. **_Dados do usuário (Opcional)_**

- É possivel especificar um script de dados do usuario ao iniciar uma instancia. O script é usado na primeira execução

- Serve para personalizar o ambiente de tempo de execução da instancia

- Pode ser usado, por exemplo, para reduzir a quantidade de AMIs personalizadas

### 6. **_Opções de armazenamento_**

- Configurar o volume raiz onde o SO será instalado

- Anexar volumes adicionais (opcional)

- Especificar para cada volume

  1.  Tamanho do disco (em GB)
  2.  Tipo de volume (SSD ou HDD)
  3.  Determinar se o volume será excluido quando a instancia for terminada
  4.  Se a criptografia precisar ser usada

- Opções de armazenamento:

  1.  Elastic block store (EBS) - é possivel interromper a instancia e os dados permanecerão
  2.  Armazenamento de instancias EC2 - armazenamento temporario que é perdido caso a instancia seja interrompida

- Outras opções de armazenamento (não servem para ser volume raiz)
  1.  Elastic file system
  2.  Amazon S3

### 7. **_Tags_**

- É um rotulo que consiste em uma chave e um valor opcional

- Beneficios: filtragem, automação, alocação de custos e controle de acesso

- Serve para anexar metadados a uma instancia EC2

  - Dados sobre sua instância, que o usuario pode usar para configurar ou gerenciar a instância em execução

  - O serviço de metadados é fornecido para cada instância no seguinte endereço IP: 169.254.169.254

  - Metadados da instância de consulta
    1.  ami-id
    2.  ami-launch-index
    3.  ami-manifest-path
    4.  block-device-mapping/
    5.  events/
    6.  hostname
    7.  iam/
    8.  instance-action
    9.  instance-id
    10. instance-type
    11. local-hostname
    12. ... continua (lista grande)

- Como ver os metadados

```bash
# criar uma variavel com o cURL
export INSTANCE_ID=$(curl http://169.254.169.254/latest/meta-data/instance-id)
# usa a variavel num comando
aws ec2 describe-instances --instance-id $INSTANCE_ID
```

### 8. **_Security group_**

- Configurar o conjunto de regras de firewall que controlam o trafego da instancia

- Configurar regras que definam as fontes, as portas e os protocolos (UTP,TCP,ICMP) que serão usadas

- Além de restringir por quais portas o tráfego pode fluir, também é possível restringir a partir de quais endereços IP o tráfego pode se originar

- Se o intervalo de endereços IP de origem for definido como 0.0.0.0/0, nessa porta será permitido tráfego a partir de qualquer origem. No entanto, o usuario também pode especificar um endereço IP específico, um intervalo de roteamento sem classe entre domínios (CIDR)

- Ou o usuario pode habilitar apenas fontes na Nuvem AWS que tenham um grupo de segurança específico atribuído a elas

- É possível atribuir vários grupos de segurança a uma única instância

  - Por exemplo, o usuario pode criar um grupo de segurança administrativo, que permitiria tráfego na porta TCP 22. O usuario também pode criar um grupo de segurança de servidor de banco de dados, que permitiria tráfego na porta TCP 3306. Em seguida, o usuario pode atribuir esses dois grupos de segurança a uma instância

- Se não existirem regras de saida entao por padrão nenhum trafego de saida será permitido

### 9. **_Par de chaves_**

- Especificar ou criar um par de chaves é fundamental para o uso da instancia e consiste em uma chave publica que a AWS armazena e uma chave privada que o usuario armazena

- O par permite conexões seguras com a instancia

- Para AMI Windows a chave serve para obter a senha do Admin necessaria para logar na instancia

- Para AMI Linux a chave serve para usar SSH e conectar com a instancia

- O Amazon EC2 incentiva o uso da criptografia de chave pública para criptografar e descriptografar informações de login

- A criptografia de chave pública usa uma chave pública para criptografar uma parte dos dados, como a senha

- O destinatário então usa uma chave privada para descriptografar os dados. As chaves pública e privada são conhecidas como par de chaves. É necessário um par de chaves para fazer login na instância

- O usuario precisa de um par de chaves conhecido e registrado nas configurações do Secure Shell (SSH) do sistema operacional ao qual o usuario está se conectando

- Normalmente, o usuario especifica o nome do par de chaves ao iniciar a instância pela primeira vez

- O usuario pode criar um novo par de chaves e baixá-lo como parte do processo de execução da instância. Ou, ao executar a instância, o usuario pode especificar um par de chaves ao qual o usuario já tem acesso

- Quando a instância é executada, a AWS cuida do processo de configuração da instância para aceitar o par de chaves que o usuario especificar

- Depois que a instância for inicializada e o usuario desejar se conectar a ela, será possível usar a chave privada para tal

  - As configurações padrão de SSH em instâncias do Linux não solicitam uma senha. Em vez disso, as instâncias do Linux esperam que o usuario use um par de chaves para fazer login, embora seja possível configurar esse processo com AMIs personalizadas
  - Em instâncias do Windows, normalmente um par de chaves é usado para descriptografar a senha de administrador e, em seguida, o login é realizado usando o Remote Desktop Protocol (RDP)

- A senha de usuário Administrador padrão para instâncias do Microsoft Windows e o ec2-user (ou outra senha de usuário padrão) em instâncias do Linux são pontos de partida. Cabe a o usuario definir sua própria segurança no nível da instância e decidir como concederá e revogará permissões para acesso à instância à medida que as pessoas ingressarem e saírem da sua organização

- Para instâncias do Microsoft Windows, use o AWS Directory Service para conceder e revogar acesso a máquinas com base em usuários e grupos existentes do Windows

- Para instâncias do Linux, várias opções de segurança estão disponíveis. Muitos administradores de sistemas optam por usar o `Kerberos`, um protocolo de autenticação de rede que usa criptografia de chave secreta para fornecer autenticação entre clientes e servidores

  - O Kerberos pode fazer parte de uma solução de Autenticação única (SSO)

- Outros administradores de sistemas Linux optam por usar ferramentas como o `ssh-keygen` para gerar seus próprios pares de chaves públicas/privadas para usuários que precisam acessar instâncias do EC2

  - Quando essa opção é escolhida, os detalhes da chave pública são configurados no arquivo.ssh/authorized_keys do usuário e a chave privada é distribuída ao usuário

- Cabe ao cliente da AWS elaborar uma estratégia para adicionar e remover permissões em uma infraestrutura de instâncias em execução

- O usuario pode criar AMIs que contenham todos os usuários atuais da sua empresa. No entanto, essa abordagem é um tanto inflexível e pode ser difícil de gerenciar até mesmo em algumas AMIs

- Aplicativos de gerenciamento de configuração (como o `Chef`, o `Puppet` e o `Ansible`) podem simplificar bastante o processo de concessão e revogação de acesso em um grande número de máquinas. Muitas vezes reduz o processo para alguns comandos

## **Ciclo de vida de uma instancia**

### **_Status das instancias:_**

- **_Pendente_**

  - Quando uma instância é executada pela primeira vez em uma AMI ou quando o usuario inicia uma instância interrompida, ela entra no estado pendente no momento em que a instância é inicializada e implantada em um computador host

  - O tipo de instância que o usuario especificou na inicialização determina o hardware de computador host para sua instância

- **_Em execução_**

  - Quando a instância está totalmente inicializada e pronta, ela sai do estado pendente e entra no estado em execução

  - É possível se conectar à instância em execução pela Internet

  - Depois que o sistema operacional (SO) da instância for inicializado, a instância deverá passar por uma verificação de status do sistema e uma verificação de status da instância. Em seguida, a instância está em um estado em execução

- **_Reinicializando_**

  - Em vez de invocar uma reinicialização do sistema operacional convidado da instância, a AWS recomenda reinicializar a instância usando o console do Amazon EC2, a AWS Command Line Interface (AWS CLI) ou os Kits de Desenvolvimento de Software (SDKs) da AWS. Uma instância reinicializada permanece no mesmo host físico e mantém o mesmo nome de DNS público e o mesmo endereço IP público. Se a instância tiver volumes de armazenamento de instâncias, ela reterá os dados nesses volumes.

- **_Desligando_**

  - Este é um estado intermediário entre em execução e terminada

- **_Interrupção_**

  - As instâncias com suporte do Amazon EBS podem ser interrompidas. Eles entram no estado de interrupção antes de atingir o estado totalmente interrompido

- **_Interrompida ou encerrada_**

  - Uma instância interrompida não incorrerá no mesmo custo que uma instância em execução. Ao iniciar uma instância interrompida, o usuario a retorna ao estado pendente, o que a move para uma nova máquina host

  - De um estado em execução, uma instância pode ser interrompida

    - No entanto, as instâncias que usam um armazenamento de instâncias em vez de um volume durável do Amazon Elastic Block Store (Amazon EBS) para o volume raiz não podem ser interrompidas. Ela só pode ser encerrada
    - As instâncias que têm um volume raiz do EBS podem ser interrompidas ou encerradas. Durante o processo de encerramento, a instância será primeiramente interrompida e, em seguida, encerrada

- **_Terminada_**

  - Uma instância terminada permanece no console do Amazon EC2 por um tempo antes da exclusão da máquina virtual. Porém, não é possível conectar-se nem recuperar uma instância terminada

- **_Hibernação_**

  - Determinados tipos de instância oferecem suporte à hibernação

  - Quando o usuario hiberna uma instância, o sistema operacional convidado preserva os dados na memória, persistindo-os no disco

  - Todos os volumes do EBS permanecem anexados à instância

  - Quando a instância é reiniciada, ela é restaurada para o estado anterior

  - O conteúdo da RAM é recarregado e os processos que estavam sendo executados anteriormente na instância são retomados

  - Como interromper e reiniciar uma instância, o endereço IPv4 público original é liberado e um novo é atribuído quando o usuario o reiniciar

  - Da mesma forma, se a instância estiver hibernando, ela reterá qualquer endereço IP elástico associado

  - O usuario não será cobrado pelo uso de uma instância em hibernação quando ela estiver no estado interrompido

  - No entanto, o usuario será cobrado pelo armazenamento em todos os volumes do EBS, incluindo o armazenamento do conteúdo da memória que persiste no disco

  - Para habilitar a hibernação, ela deve ser configurada na inicialização usando o Console de gerenciamento da AWS ou a AWS Command Line Interface (AWS CLI)

    - `Não é possível habilitar a hibernação em uma instância existente que esteja em execução ou parada`

  - As imagens de máquina da Amazon (AMIs) compatíveis incluem o Amazon Linux AMI 2018.03 lançado em 16 de novembro de 2018 ou posterior

  - O volume raiz da instância deve ser um volume do EBS. O volume do EBS deve ser grande o suficiente para armazenar o conteúdo da RAM e acomodar o uso esperado, como o sistema operacional ou os aplicativos

  - Quando a hibernação é habilitada, é alocado um espaço no volume raiz na inicialização para armazenar a RAM

  - Por fim, o volume raiz do EBS deve ser criptografado para garantir a proteção do conteúdo confidencial na memória

  - Quando os dados da RAM são transferidos para o volume raiz do EBS, eles são sempre criptografados

  - A criptografia do volume raiz é imposta na execução da instância

    - Para garantir que o volume raiz seja um volume criptografado do Amazon EBS, a AMI usada para executar sua instância deve ser criptografada

  - O recurso de hibernação só está disponível para instâncias sob demanda, instâncias spot e instâncias reservadas

- **_Resumo_**
  |Estado|_Em execução_|_Interrompida_|_Encerrada_|_Hibernando_|
  |:------:|:-----:|:-----:|:-----:|:-----:|
  |**Cobrado**?|COBRADO|NÃO COBRADO|NÃO COBRADO|NÃO COBRADO|
  |**Armazenamento**|RETIDO|PERDIDO|PERDIDO|:----RETIDO|
  |**Volume EBS**|RETIDO|RETIDO|EXCLUIDO (se `deleteontermination` estiver habilitado)|RETIDO|
  |**Ip publico**|RETIDO|LANÇADO|LANÇADO|LANÇADO|
  |**Ip elastico**|RETIDO|RETIDO|DESASSOCIADO|RETIDO|

## **Modelos de preço**

- **_Instancias on-demand_** (Baixo custo e flexibilidade)
  - Pagamento por hora
  - Sem compromisso de longo prazo
  - Qualificado para o nivel gratuito da AWS
  - Possui a opção de cobrança por segundo
- **_Hosts dedicados_** (Atende requesitos regulatorios/conformidade)
  - Um servidor fisico com capacidade de instancia EC2 totalmente dedicado para uso
- **_Instancias dedicadas_**
  - Instancias que são executadas em uma VPC em hardware dedicado a um unico cliente
- **_Instancias reservadas_** (Baixo custo e previsibilidade)
  - Pagamento total, parcial ou não antecipado para a instancia que o cliente reservar
  - Desconto na cobrança por hora
  - Periodo de 1 a 3 anos
  - Possui a opção de cobrança por segundo
- **_Instancias reservadas programadas_** (Baixo custo e previsibilidade)
  - Compra uma reserva de capacidade que estará disponivel no periodo escolhido pelo cliente
  - Periodo de 1 ano
- **_Instancias Spot_**(Dinamica, larga escala, custo competitivo)
  - As instancias são executadas desde que estejam disponiveis e a sua sugestão de preço seja superior ao preço da instancia spot
  - Podem ser interrompidas pela AWS com uma notificação de 2 minutos
  - Pode ser interrompida, hibernada ou terminada
  - Os preços podem ser bem menores que as instancias on-demand
  - Boa opção quando se tem flexibilidade sobre quando os aplicativos podem ser executados
  - É feito o pagamento pela programação de uso mesmo que não aconteça
  - Permite que o usuario faça sugestões de preço em instâncias do EC2 não utilizadas, o que pode reduzir seus custos do significativamente. O preço por hora de uma instância spot varia de acordo com a oferta e a demanda. A instância spot é executada sempre que sua sugestão de preço excede o preço de mercado atual.

## **Como funciona**

- As instâncias do EC2 são executadas como máquinas virtuais em computadores host localizados nas zonas de disponibilidade da AWS

- Cada máquina virtual executa um sistema operacional (SO), como Amazon Linux ou Microsoft Windows

- É possível instalar e executar aplicativos no sistema operacional em cada máquina virtual ou até mesmo executar aplicativos empresariais que abrangem várias máquinas virtuais

- As máquinas virtuais são executadas sobre uma camada de hipervisor, que é mantida pela AWS

  - O hipervisor é a camada de plataforma operacional que fornece às instâncias do EC2 acesso ao hardware real que as instâncias precisam executar
  - Esse hardware inclui processadores,memória e armazenamento
  - Cada instância do EC2 recebe um número específico de CPUs virtuais para processamento e uma quantidade de memória ou RAM

- Algumas instâncias do EC2 usam um armazenamento de instâncias

  - O armazenamento de instâncias também é conhecido comoarmazenamento temporário
  - É um armazenamento fisicamente conectado ao computador host e fornece armazenamento temporário em nível de bloco para uso com uma instância
  - Os dados em um armazenamento de instâncias persistem apenas durante o tempo de vida da instância à qual estão associados
  - Se uma instância for reinicializada, os dados no armazenamento de instâncias persistirão
  - Se a instância for interrompida ou encerrada, os dados no armazenamento de instâncias serão perdidos e não poderão ser recuperados

- Muitas instâncias do EC2 usam o Amazon Elastic Block Store (Amazon EBS) para o disco de inicialização e outras necessidades de armazenamento, em vez de um armazenamento de instâncias

- O Amazon EBS fornece volumes persistentes de armazenamento em bloco, o que significa que os dados serão persistidos

  - Por exemplo, os dados ainda persistem nessa instância, mesmo quando a instância do EC2 está em um estado interrompido

- As instâncias otimizadas para Amazon EBS minimizam a contenção de entrada/saída (E/S) entre o Amazon EBS e outro tráfego da sua instância, o que fornece melhores garantias de desempenho

- A contenção de E/S ocorre quando as máquinas virtuais competem por recursos de E/S porque há uma largura de banda de armazenamento limitada

- As instâncias do EC2 podem ter conectividade de rede com outros recursos

- Esses recursos podem ser outras instâncias do EC2, armazenamento de objetos do Amazon Simple Storage Service (Amazon S3) e a Internet em geral

- É possível configurar o grau de acesso à rede para atender às suas demandas e equilibrar as necessidades de acessibilidade com os requisitos de segurança

- Diferentes tipos de instância fornecem níveis diferentes de desempenho de rede

- Os tipos de instância referem-se à seleção disponível de instâncias a serem escolhidas para suas cargas de trabalho

- Existem muitos tipos de instâncias, alguns são de uso geral, enquanto outros são projetados para fornecer CPU adicional (potência de processamento), RAM adicional (memória) ou desempenho adicional de rede de E/S

- Há muitas variações, categorias, famílias e tipos

- O usuario deve escolher o tipo de instância mais econômico que ofereça suporte aos requisitos da carga de trabalho

- Outra opção útil que pode ser invocada quando o usuario executa uma instância a partir de uma AMI é o parâmetro de dados do usuário

- Os dados do usuário são uma ferramenta poderosa que pode ajudar a implantar instâncias do EC2 de forma automatizada e repetível

- Com os dados do usuário, é possível fornecer um script para uma instância do Linux ou Windows

- Quando a instância é executada, esse script é executado como uma série de comandos durante o fim do processo de inicialização

- Os scripts assumem a forma de scripts de shell em instâncias do Linux ou scripts em lote ou PowerShell em instâncias do Windows

- Ao usar os dados do usuário, é possível automatizar a configuração de uma nova instância sem precisar fazer login nela

- Um script de dados de usuário pode, por exemplo, fazer download e executar um script mais longo armazenado em um bucket do Amazon S3

- Também é possivel fazer download e instalar um sistema de gerenciamento de configuração, como o `Chef` ou o `Puppet`. Em seguida, inicie uma tarefa de inicialização de um receita do `Chef` ou de um módulo `Puppet`

- Além disso, é possível chamar comandos da Interface de linhas de comando da AWS (AWS CLI) a partir de seus scripts. Esse processo pressupõe que o usuario inclua código ou instruções para instalar a AWS CLI anteriormente no seu script. (Essas instruções não seriam necessárias se a instância já tiver a AWS CLI pré-instalada nela)

- As instâncias do Amazon Linux vêm com a CLI do AWS pré-instalada nelas

- Os scripts de dados do usuário são executados pelo serviço cloud-init em instâncias do Linux ou pelo serviço EC2Launch em instâncias do Windows

- Por padrão, scripts de dados do usuário e diretivas cloud-init são executados somente durante o primeiro ciclo de inicialização quando uma instância é iniciada. No entanto, o usuario pode configurar scripts de dados do usuário e diretivas cloud-init para serem executadas sempre que a instância for reiniciada a partir de um estado interrompido

- Para fornecer visibilidade sobre o estado das instâncias, a AWS oferece a capacidade de gerar e salvar uma captura de tela do console da instância a partir do Console de gerenciamento da AWS

- Para ajudar a proteger contra a perda de dados causada pelo encerramento acidental de uma instância do Amazon EC2, considere habilitar a proteção contra encerramento

  - A proteção contra encerramento impede que uma instância seja encerrada acidentalmente, exigindo que a proteção contra encerramento seja desativada antes que a instância possa ser encerrada

- Por padrão, toda instância do EC2 executa verificações de origem/destino. Isso significa que a instância deve ser a origem ou o destino de qualquer tráfego que ela envia ou recebe. Entretanto, a instância de conversão de endereços de rede (NAT) deve poder enviar e receber tráfego quando ela não for a origem nem o destino. Por isso, é preciso desativar as verificações de origem/destino na instância NAT

- `Executar o Amazon EC2 na CLI da AWS`

  ```bash
  aws ec2 run-instances --image-id ami-0123456789012345 --instance-type t2.micro --key-name mykeypair --security-group-ids sg-0123456789012345 --subnet-id subnet-0123456789012345 --iam-instance-profile Name=EC2Admin --user-data file://UserData.txt
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=WebServer}]'
  ```

  - O parâmetro subnet-id é opcional. Se o usuario não especificar um, a instância será executada na sub-rede padrão da VPC padrão
  - O parâmetro tag-specifications permite aplicar tags, como um valor de nome à instância

- É uma prática recomendada considerar instâncias do EC2 como recursos temporários, que podem ser criados, desativados e recriados a qualquer momento

- Muitas situações na nuvem exigem a criação de um novo servidor do zero, incluindo:

  1. **_Escalonamento automático_**
     - O usuario pode ter soluções que devem ser capazes de implantar novas instâncias sem intervenção humana
     - Procedimento para instancia com EBS: Interrompe -> Modifica -> Inicia nova
     - Procedimento para instancia com armazenamento de instancia: Migra da velha para a nova instancia
  2. **_Economia de custos_**
     - O usuario pode decidir que não precisa manter uma instância agora. No entanto, talvez o usuario precise da capacidade de recriá-lo em um curto espaço de tempo. Os casos de uso de processamento em lote geralmente estão nessa categoria
  3. **_Downgrade_**
     - talvez o usuario queira fazer downgrade de uma instância de alguma forma, para economizar custos. Por exemplo, o usuario pode fazer um downgrade de uma instância executada em hardware dedicado a o usuario como único cliente para um hardware com locação compartilhada. Ou talvez o usuario queira fazer downgrade do tamanho de uma instância, por exemplo, de t2.xlarge para t2.large
  4. **_Reparação de instâncias prejudicadas_**
     - O hardware subjacente que suporta uma instância do EC2 pode falhar. A inicialização de uma instância colocará a nova instância do EC2 em uma infraestrutura saudável
  5. **_Atualização_**

     - Outra situação que pode exigir a execução de novas instâncias quando o usuario deseja atualizar a arquitetura do sistema operacional ou o tipo de imagem

     - A descontinuação da AMI não afeta as instâncias em execução

     - AMIs do Microsoft Windows

       - Defasadas logo após o lançamento da nova imagem
         – As AMIs são lançadas dentro de 5 dias após o patch da Microsoft
       - Encontrar por nome, não pelo ID da AMI

     - AMIs do Amazon Linux

       - Disponíveis por anos
       - Consulta a AMI do Amazon Linux mais recente

     - `Lembre-se: Manter as instancias atualizadas é responsabilidade do usuario`

     - As atualizações do Microsft Windows podem ser instaladas automaticamente por meio do Windows Update

     - O usuario também pode optar por desativar as atualizações automáticas e instalar atualizações manualmente, dessa forma, o usuario pode testar atualizações recentes para garantir que elas não quebrem nenhum aplicativo existente que possa estar sendo executado no servidor

     - O YUM, que significa Yellowdog Updater, Modified, é um instalador de pacotes baseado no Redhat Package Manager (RPM) de código aberto para Linux

     - Para instâncias do Amazon Linux, a AWS mantém seu próprio repositório de software YUM

     - É possível executar o YUM para instalar todas as atualizações disponíveis mais recentes para todos os aplicativos atualmente em seu servidor

     - Ele também pode ser usado para instalar atualizações uma de cada vez, se for feita uma referência apenas a nomes de pacotes específicos

     - Os serviços AWS Systems Manager e AWS OpsWorks oferecem recursos que simplificam a atualização de instâncias do EC2

     - Há também ferramentas de gerenciamento de configuração de terceiros disponíveis

## **EC2 Auto Scaling**

- O Amazon EC2 Auto Scaling ajuda o usuario a manter a disponibilidade dos aplicativos

- Ele permite que o usuario adicione ou remova automaticamente instâncias do Amazon Elastic Compute Cloud (Amazon EC2) de acordo com as condições definidas por o usuario

  - Por exemplo, o usuario pode configurar o Amazon EC2 Auto Scaling para encerrar instâncias do EC2 que falham nas verificações de status de saúde. Em seguida, o usuario pode configurá-lo para executar novas instâncias do EC2 para substituir as encerradas.
  - Ou o usuario pode criar políticas definidas pelo usuário que usam o Amazon CloudWatch para acionar quando adicionar ou remover instâncias do Amazon EC2. Essas políticas seriam baseadas em condições como a utilização média da CPU da sua frota do Amazon EC2

- Se o usuario tem alterações de carga previsíveis a fazer, pode definir uma programação por meio do Auto Scaling do Amazon EC2 para planejar as atividades de escalabilidade

- Os recursos do Amazon EC2 Auto Scaling oferecem a capacidade de expandir para atender à demanda e aumentar a escala para reduzir custos

- Observação: o usuario também pode criar um grupo de escalabilidade usando uma `configuração de execução`, mas a AWS recomenda enfaticamente que o usuario não use configurações de execução e use um `modelo de execução`

  - Um modelo de execução especifica a configuração da instância do EC2, como AMI, tipo de instância, grupo de segurança

  - Para criar um modelo de inicialização, o usuario deve especificar:

  1. Imagem de máquina da Amazon (AMI)
  2. Tipo de instância
  3. VPC
  4. Grupo de segurança
  5. Armazenamento
  6. Par de chaves de instância
  7. Funções do IAM
  8. Dados do usuário
  9. Marcação

- Para configurar o Amazon EC2 Auto Scaling, o usuario deve primeiro criar um modelo de execução e, em seguida, criar um grupo do Auto Scaling

- O grupo de escalabilidade deve usar a VPC do grupo de segurança especificado no modelo de execução

- O usuario pode escolher uma ou várias sub-redes. A escolha de várias sub-redes em várias zonas de disponibilidade garante alta disponibilidade

- O balanceador de carga permite distribuir o tráfego entre várias instâncias do EC2, dependendo da carga de trabalho das instâncias e da sua integridade

- O monitoramento dá a o usuario uma maior visibilidade ao obter a coleta de métricas

- O tamanho do grupo permite determinar a capacidade mínima e máxima do grupo. À medida que a demanda cresce, o grupo se expande para usar mais instâncias. Se a demanda diminuir, o grupo aumentará e encerrará instâncias que não são mais necessárias

- O Auto Scaling também determina a integridade das instâncias, fornecidas pela instância do EC2, pelo balanceador de carga ou pelas verificações de integridade personalizadas. SE uma instância não estiver íntegra, ela será substituída

- `O dimensionamento automático pode ser definido de três maneiras:`

  1. Defina uma política de escalabilidade que seja escalável ou escalável com base em um alarme do Amazon CloudWatch

  - O usuario pode definir um alarme do CloudWatch, por exemplo, Utilização média da CPU > 50% por 2 minutos—que chama uma política do Auto Scaling do EC2 A política especifica uma das duas opções

    1.  A primeira opção, dimensionamento simples, é adicionar ou remover um número fixo de instâncias
    2.  A segunda opção, dimensionamento por etapas, é ajustar o número de instâncias em execução como uma porcentagem da capacidade desejada para o grupo do Amazon EC2 Auto Scaling

  2.  Defina uma Política de rastreamento de destino em que uma métrica, como a Utilização média da CPU, seja avaliada em relação a um destino

  - Por exemplo, mantenha a utilização média da CPU do seu grupo de Auto Scaling em 50%

  - O usuario também pode definir uma ação agendada
    - As ações agendadas definem um novo valor de capacidade desejado em um horário específico
    - O usuario pode especificar uma ação programada para ser acionada em uma data e hora específicas
    - O usuario também pode especificar uma ação recorrente executada em momentos específicos durante uma semana, mês ou ano
    - As ações programadas são uma excelente maneira de pré-aquecer a capacidade em resposta a picos de tráfego previstos

- O Amazon EC2 Auto Scaling rastreia o estado de integridade das instâncias e encerra instâncias marcadas como não íntegras

- Por padrão, o Amazon EC2 Auto Scaling usa verificações de status de instâncias do EC2

- Se um grupo de Auto Scaling estiver atrás de um balanceador de carga, as verificações de instância do balanceador de carga ou as verificações de instância do EC2 serão usadas para monitoramento de integridade

- Scripts externos podem acionar a reciclagem de uma instância invocando o comando

  ```bash
  aws autoscaling set-instance-health.
  ```

- Com cada grupo de Auto Scaling, o usuario controla quando ele adiciona instâncias (scaling out) ou remove instâncias (dimensionamento) da arquitetura de rede

- O usuario pode dimensionar o tamanho do grupo manualmente anexando e desanexando instâncias, ou o usuario pode automatizar o processo usando uma política de dimensionamento

- A política de encerramento padrão foi criada para ajudar a garantir que suas instâncias atravessem as Zonas de disponibilidade uniformemente para alta disponibilidade

- A política de encerramento padrão costuma ser suficiente para a maioria das situações. No entanto, o usuario tem a opção de substituir a política padrão por uma personalizada.

  - Por exemplo, o usuario pode definir uma política de encerramento personalizada para especificar quais instâncias serão encerradas primeiro durante a redução

- Use a ação `TerminateInstanceInAutoScalingGroup` da API do Amazon EC2 Auto Scaling para encerrar atomicamente uma instância específica e, opcionalmente, diminuir o tamanho do grupo desejado

  - Por exemplo, o usuario pode optar por sempre encerrar a instância com o menor número de sessões de usuários
  - Primeiro determine o ID da instância com o menor número de sessões de usuário e, em seguida, chame `TerminateInstanceInAutoScalingGroup` e passe o ID da instância como um parâmetro

- O Amazon EC2 Auto Scaling oferece suporte a políticas de encerramento personalizadas, incluindo as listadas aqui:

  - **_`OldestInstance`_**
    - Encerra a instância mais antiga do grupo
    - Esta opção é útil quando o usuario está atualizando as instâncias no grupo de Auto Scaling para um novo tipo de instância do EC2
    - O usuario pode gradualmente substituir instâncias do tipo antigo pelas do novo tipo
  - **_`NewestInstance`_**
    - Encerra a instância mais recente no grupo
    - Essa política é útil quando o usuario está testando um novo modelo de execução, mas não quer mantê-lo em produção
  - **_`OldestLaunchTemplate`_**
    - Encerra instâncias que têm o modelo de execução mais antigo
    - Essa opção é boa quando o usuario está atualizando um grupo e eliminando as instâncias de uma configuração de modelo anterior
  - **_`ClosestToNextInstanceHour`_**
    - Encerra instâncias mais próximas da hora de faturamento seguinte
    - É uma boa maneira de maximizar o uso de suas instâncias e gerenciar seus custos de uso do Amazon EC2

- As verificações de saúde do Amazon EC2 Auto Scaling permitem que o usuario crie um grupo de estado estável que garante que uma única instância esteja sempre em execução

  - Por exemplo, suponha que o usuario tenha um servidor NAT que não deseja que seja um único ponto de falha em uma arquitetura de sub-rede público-privada padrão. Um grupo de estado estacionário é útil para essa instância

- Para criar um grupo de estado fixo para uma instância:

  1. Crie um modelo de execução que crie a instância
  2. Crie um grupo do Amazon EC2 Auto Scaling com um tamanho mínimo, máximo e desejado de 1

- Quando uma dessas instâncias é marcada como não íntegra, pode ser porque uma verificação de instância falha. Ou um script externo pode marcar a instância como não íntegra com uma chamada para o comando aws autoscaling set-instance-health da AWS CLI

- O grupo do Amazon EC2 Auto Scaling encerrará a instância existente e criará uma nova instância a partir do modelo de execução do grupo
  - Observe que, em casos como a implantação de uma instância NAT, o NAT ainda é um único ponto de falha. O usuario ainda pode experimentar um tempo de inatividade significativo enquanto uma instância NAT com falha está sendo reciclada

### **_Escalabilidade_**

#### **_Dimensionamento com base em um cronograma_**

- Permite que o usuario dimensione seu aplicativo em resposta a alterações de carga previsíveis

  - Por exemplo, digamos que toda semana o tráfego para a aplicação Web começa a aumentar na quarta-feira, permanece alto na quinta-feira e começa a diminuir na sexta-feira. Em situações como essa, o usuario pode planejar as atividades de escalabilidade com base nos padrões de tráfego previsível de sua aplicação Web.

- Para configurar um grupo de Auto Scaling para escalar com base em uma programação:

  1. Crie uma ação programada que informe ao Auto Scaling do Amazon EC2 para executar uma ação de escalabilidade em horários especificados
  2. Especifique o horário de início em que a ação de escalabilidade deve entrar em vigor, além dos novos tamanhos mínimo, máximo e desejado para a ação de escalabilidade
  3. No horário especificado, o Amazon EC2 Auto Scaling atualiza o grupo. Ele atualiza os valores para o tamanho mínimo, máximo e desejado que a ação de dimensionamento especificou.

#### **_Dimensionamento dinâmico_**

- Por exemplo, digamos que o usuario tenha um aplicativo da Web que é executada em duas instâncias atualmente. O usuario não deseja que a utilização da CPU do grupo do Auto Scaling exceda 70% por mais de 2 minutos. O usuario pode configurar seu grupo de Auto Scaling para dimensionar automaticamente a fim de atender a essa necessidade.

- O tipo de política determina como a ação de escalabilidade será executada

- O Auto Scaling do Amazon EC2 oferece suporte aos seguintes tipos de políticas de escalabilidade:

  - `Dimensionamento de monitoramento de destino`

    - Aumente ou diminua a capacidade atual do grupo com base em um valor de destino para uma métrica específica - Esse tipo de dimensionamento é semelhante à forma como o termostato mantém a temperatura da sua casa. O usuario seleciona uma temperatura e o termostato faz o resto do trabalho
      ‒ No caso do Amazon EC2, o usuario define a métrica para que o Amazon EC2 Auto Scaling a monitore e Amazon EC2 Auto Scaling faz o resto do trabalho

  - `Dimensionamento de etapas`

    - Aumente ou diminua a capacidade atual do grupo com base em um conjunto de ajustes de escala, conhecidos como ajustes de etapa
    - Esses ajustes de dimensionamento variam de acordo com o tamanho da violação do alarme
    - O Auto Scaling do Amazon EC2 não oferece suporte a desaquecimentos para políticas de escalabilidade em etapas
      ‒ Portanto, o usuario não pode especificar um período de recarga para essas políticas, e o período de recarga padrão para o grupo não se aplica

  - `Dimensionamento simples`

    - Aumente ou diminua a capacidade atual do grupo com base em um único ajuste de escala
    - Seu dimensionamento pode ser baseado em uma métrica de utilização que aumenta ou diminui proporcionalmente ao número de instâncias em um grupo do Auto Scaling
    - Nesse caso, a abordagem recomendada é usar políticas de dimensionamento de rastreamento de destino. Caso contrário, é recomendável usar políticas de dimensionamento de etapas

  - `Dimensionamento preditivo`

    - Usa modelos de aprendizado de máquina para prever o tráfego esperado (e o uso do Amazon EC2), incluindo padrões diários e semanais
    - Essas previsões usam dados coletados do uso real do Amazon EC2 e pontos de dados extraídos das suas próprias observações
    - O modelo precisa de dados históricos de pelo menos 1 dia para iniciar as previsões
    - O modelo é reavaliado a cada 24 horas para criar uma previsão para as próximas 48 horas
    - O dimensionamento preditivo prevê o tráfego futuro com base nas tendências diárias e semanais, incluindo picos que ocorrem regularmente. Ele provisiona o número correto de instâncias do EC2 antes das alterações previstas
    - O dimensionamento preditivo elimina a necessidade de ajustar manualmente os parâmetros do Auto Scaling ao longo do tempo, o que torna o Auto Scaling mais simples de configurar e consumir

      1. Para começar, navegue até a página do AWS Auto Scaling no grupo de serviços “Gerenciamento e governança”. Uma vez criado um plano de escalabilidade para recursos do Amazon EC2 que inclui escalabilidade preditiva.
      2. Após a habilitação da escalabilidade preditiva, o usuario pode visualizar o tráfego previsto e as ações de escalabilidade geradas

    - O usuario pode usar a escalabilidade preditiva, a escalabilidade dinâmica, ou ambas
    - A escalabilidade preditiva funciona ao prever a carga e programar a capacidade mínima; a escalabilidade dinâmica usa o rastreamento de destino para ajustar uma métrica designada do CloudWatch a um destino específico
    - Os dois modelos funcionam bem juntos devido à capacidade mínima programada que o dimensionamento preditivo já definiu
    - O dimensionamento preditivo é uma boa opção para sites e aplicativos que experimentam picos de tráfego periódicos
    - Ela não é projetada para ajudar em situações em que picos de carga não são cíclicos ou previsíveis.
